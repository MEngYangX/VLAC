# Vespera Lumen AntiCheat (VLAC) 开发文档

## 项目概述
Vespera Lumen AntiCheat（VLAC）是一个为Minecraft开发的基于Fabric的反作弊模组。该模组旨在检测和防止各种作弊行为，保护服务器的公平性和玩家体验。

## 项目目标
- 检测和防止常见的作弊行为（如飞行、速度修改、自动点击等）
- 提供灵活的配置选项，使服务器管理员可以根据需要自定义反作弊规则
- 最小化对正常玩家的影响，减少误判
- 提供详细的日志和报告系统，方便管理员监控和分析可疑行为
- 与Minecraft版本1.21.5兼容
- **支持LuckPerms权限系统**，实现基于权限的反作弊控制

## 技术架构

### 核心组件
1. **检测系统**：负责监控和分析玩家行为，识别潜在的作弊行为
2. **处罚系统**：根据配置对检测到的作弊行为执行相应的处罚
3. **配置系统**：提供灵活的配置选项，允许管理员自定义检测和处罚规则
4. **日志系统**：记录检测到的作弊行为和执行的处罚
5. **权限系统**：集成LuckPerms，提供基于权限的功能控制和检测豁免

### 文件结构
```
src/
├── main/                    # 主要代码
│   ├── kotlin/              # Kotlin源代码
│   │   └── com/mengyangx/vlac/
│   │       ├── VesperaLumenAntiCheat.kt       # 主类
│   │       ├── detection/                      # 检测系统
│   │       ├── punishment/                     # 处罚系统
│   │       ├── config/                         # 配置系统
│   │       └── util/                           # 工具类
│   │           └── PermissionUtils.kt          # 权限工具类
│   └── resources/           # 资源文件
│       ├── fabric.mod.json  # Fabric模组配置
│       └── assets/          # 模组资源
└── client/                  # 客户端专用代码
    └── kotlin/
        └── com/mengyangx/vlac/
            └── VesperaLumenAntiCheatClient.kt  # 客户端主类
```

## 实现方式

### 检测系统
检测系统将利用Fabric API提供的事件和钩子来监控玩家行为。主要检测类型包括：

1. **移动检测**：检测不合理的移动速度、飞行等
2. **战斗检测**：检测自动点击、攻击范围异常等
3. **交互检测**：检测与方块和实体的异常交互
4. **其他检测**：如聊天行为分析等

每种检测都将有独立的检测器类，负责分析特定类型的行为并判断是否为作弊。

### 处罚系统
处罚系统提供多种处罚方式，包括：

1. 警告玩家
2. 踢出服务器
3. 暂时封禁
4. 永久封禁
5. 命令执行

服务器管理员可以为不同的作弊行为配置不同的处罚方式和级别。

### 配置系统
配置系统使用YAML格式，允许管理员自定义：

1. 模组的主开关（enabled）
2. 语言设置（language）
3. 调试模式（debug）
4. 每种检测的启用/禁用状态
5. 检测灵敏度和阈值
6. 处罚方式和级别
7. **权限设置**：LuckPerms集成配置

配置文件位于游戏的`config/VLAC/config.yml`，采用YAML格式，便于手动编辑和阅读。

### 语言系统
VLAC提供了完善的多语言支持，允许管理员选择不同的界面语言：

1. 支持中文(zh_CN)和英文(en_US)，可扩展更多语言
2. 语言文件位于游戏的`config/VLAC/lang/`目录
3. 可以通过配置文件中的`language`选项切换语言
4. 服务器管理员可以自定义或编辑语言文件，添加或修改文本内容

### 日志系统
日志系统将记录所有检测到的可疑行为和执行的处罚，包括时间、玩家名、行为类型、处罚类型等信息。日志可以保存到文件或发送到管理员。

### 权限系统
VLAC集成了LuckPerms权限系统，提供以下功能：

1. **基于权限的检测豁免**：管理员可以为特定玩家或权限组设置检测豁免
2. **基于权限的命令访问**：限制特定玩家使用VLAC管理命令
3. **基于权限组的处罚差异化**：为不同权限组设置不同的处罚规则

#### 权限节点
VLAC使用以下权限节点：

| 权限节点 | 描述 |
|---------|------|
| `vlac.admin` | 完全访问VLAC的所有功能 |
| `vlac.command.*` | 使用所有VLAC命令的权限 |
| `vlac.command.<命令名>` | 使用特定VLAC命令的权限 |
| `vlac.bypass.all` | 绕过所有检测 |
| `vlac.bypass.<检测类型>` | 绕过特定类型的检测 |
| `vlac.notifications` | 接收违规通知 |

## 使用方法
1. 将模组JAR文件放入服务器的mods文件夹
2. 启动服务器，模组将自动在config目录下创建VLAC文件夹并生成默认配置文件
3. 根据需要编辑`config/VLAC/config.yml`文件，自定义模组设置
4. 如需自定义语言，可编辑`config/VLAC/lang/`目录下的语言文件
5. 重启服务器，应用新的配置

### 配置示例
```yaml
# VLAC主配置文件
enabled: true              # 是否启用VLAC
language: zh_CN            # 界面语言，支持zh_CN和en_US
debug: false               # 是否启用调试模式

# 权限配置
permissions:
  useLuckPerms: true       # 是否使用LuckPerms
  bypassGroups:            # 豁免检测的权限组
    - admin
    - mod
```

### 配置LuckPerms集成
1. 确保服务器已安装LuckPerms模组
2. 在VLAC配置文件中，找到`permissions`部分
3. 设置`useLuckPerms: true`启用LuckPerms集成
4. 在`bypassGroups`列表中添加豁免组名称
5. 使用LuckPerms命令为玩家或组分配VLAC权限

示例权限命令：
```
/lp user <玩家名> permission set vlac.bypass.fly true
/lp group admin permission set vlac.admin true
```

## 开发计划
1. **阶段1**：实现基本框架和配置系统
2. **阶段2**：实现核心检测系统（移动、战斗）
3. **阶段3**：实现处罚系统和日志系统
4. **阶段4**：添加更多检测类型和优化
5. **阶段5**：完善文档和测试

## 当前状态
项目目前处于初始开发阶段，已实现基本框架和配置系统。目前仅包含以下基本功能：

1. **配置系统**：使用YAML格式配置文件，支持模组主开关、语言设置和调试模式
2. **语言系统**：支持中文和英文界面，可通过配置或命令切换
3. **命令系统**：支持基本的管理命令，包括重载配置、切换模组开关、调试模式和语言设置
4. **权限系统**：集成LuckPerms，支持基于权限的命令访问控制

反作弊检测功能将在后续版本中实现。

## 下一步开发计划

1. 完善配置系统，增加更多选项
2. 实现基础的玩家行为监控框架
3. 开发核心检测模块
4. 完善权限系统和通知系统

## LuckPerms集成说明
为了避免LuckPerms初始化问题，我们采取了以下技术措施：

1. 模组使用服务器生命周期事件延迟初始化
2. 在fabric.mod.json中将LuckPerms声明为软依赖
3. 系统能够优雅地处理LuckPerms不可用的情况

这种方法确保了无论是否安装了LuckPerms，模组都能正常工作，并防止因加载顺序问题导致的初始化错误。 