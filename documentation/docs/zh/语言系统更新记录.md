# VLAC 语言系统更新记录

## 2024-06-10 更新：1.21.5 版本兼容性修复

在针对Minecraft 1.21.5版本的开发过程中，我们遇到了以下问题：

1. **clientLanguageCode 属性不可用**
   - 在1.21.5版本中，ServerPlayerEntity不再直接提供`clientLanguageCode`属性
   - 这导致之前的自动语言检测功能无法正常工作
   - 所有尝试使用`player.clientLanguageCode`的代码都会触发编译错误

2. **临时解决方案**
   - 修改了`VLACCommand.kt`文件，将所有对`clientLanguageCode`的引用替换为默认值`"en_us"`
   - 这使得模组能够正常编译和运行，但限制了自动检测客户端语言的功能
   - 目前所有玩家默认使用英文，除非手动设置为中文

3. **影响范围**
   - `/vlac language auto` 命令仍然可用，但现在默认将所有玩家设置为英文
   - 手动设置语言功能正常工作（`/vlac language zh_CN` 和 `/vlac language en_US`）
   - 所有命令反馈和消息都能正常显示，但默认不再根据客户端语言自动选择

## 后续改进计划

1. **研究正确获取客户端语言的方法**
   - 深入研究Minecraft 1.21.5的API，寻找获取玩家客户端语言设置的新方法
   - 可能的研究方向：
     - ServerPlayNetworkHandler 类
     - 网络数据包分析
     - 混入(Mixin)方法获取客户端语言信息

2. **恢复自动语言检测功能**
   - 一旦找到正确的方法，更新LanguageManager和VLACCommand中的代码
   - 确保auto模式能够正确检测玩家的客户端语言设置

3. **添加语言设置持久化**
   - 考虑将玩家的语言设置保存到文件中，以便服务器重启后仍然可用
   - 实现一个配置系统，自动保存和加载玩家的语言偏好

## 技术笔记

目前我们知道在Minecraft 1.21.5中:

1. 语言相关的类可能包括:
   - `net.minecraft.client.resource.language.LanguageManager` (仅客户端)
   - `net.minecraft.client.resource.language.TranslationStorage` (仅客户端)

2. 服务器端不直接访问客户端语言设置，可能需要通过网络包通信

3. 可能的解决方案:
   - 在玩家首次连接时发送一个请求语言信息的网络包
   - 使用mixin修改客户端的一些行为以将语言信息发送到服务器
   - 为每个玩家提供一个配置命令手动设置他们的语言偏好

如果任何开发者找到了更好的解决方案，请在本文档中更新信息。 