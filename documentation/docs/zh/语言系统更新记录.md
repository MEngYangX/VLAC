# VLAC 语言系统更新记录

## 2024-06-11 更新：1.21.5 版本改进和问题修复

在针对Minecraft 1.21.5版本的开发过程中，我们修复了几个关键问题：

1. **获取客户端语言的新方法**
   - 修复：使用`ServerPlayerEntity.getClientOptions().language()`方法获取玩家客户端语言设置
   - 代替了原有的`player.clientLanguageCode`属性，该属性在1.21.5版本中不可用
   - 这使得自动语言检测功能恢复正常工作，可以正确根据玩家客户端语言设置显示对应语言

2. **语言文件缺失问题解决**
   - 问题：部分语言条目（如`vlac.command.language.mode_manual`）在游戏中无法正确显示
   - 原因分析：可能是由于服务器升级或其他原因导致语言文件损坏或缺失
   - 解决方案：确保语言文件在服务器第一次启动或配置文件被删除时正确重新创建

3. **重要提示**
   - 如果在游戏中依然看不到某些文本（显示为语言条目名称），请尝试以下解决方法：
     - 删除`config/vlac/lang/`目录中的语言文件，让模组重新创建
     - 执行`/vlac reload`命令重新加载配置和语言文件
     - 切换语言模式（`/vlac language auto`或`/vlac language zh_CN`）

## 2024-06-10 更新：1.21.5 版本兼容性修复

在针对Minecraft 1.21.5版本的开发过程中，我们遇到了以下问题：

1. **clientLanguageCode 属性不可用**
   - 在1.21.5版本中，ServerPlayerEntity不再直接提供`clientLanguageCode`属性
   - 这导致之前的自动语言检测功能无法正常工作
   - 所有尝试使用`player.clientLanguageCode`的代码都会触发编译错误

2. **临时解决方案**
   - 修改了`VLACCommand.kt`文件，将所有对`clientLanguageCode`的引用替换为默认值`"en_us"`
   - 这使得模组能够正常编译和运行，但限制了自动检测客户端语言的功能
   - 目前所有玩家默认使用英文，除非手动设置为中文

3. **影响范围**
   - `/vlac language auto` 命令仍然可用，但现在默认将所有玩家设置为英文
   - 手动设置语言功能正常工作（`/vlac language zh_CN` 和 `/vlac language en_US`）
   - 所有命令反馈和消息都能正常显示，但默认不再根据客户端语言自动选择

## 后续改进计划

1. **✅ 已完成：研究正确获取客户端语言的方法**
   - 使用`ServerPlayerEntity.getClientOptions().language()`方法获取玩家客户端语言设置
   - 已更新VLACCommand.kt中所有相关代码

2. **✅ 已完成：恢复自动语言检测功能**
   - 更新了LanguageManager和VLACCommand中的代码
   - 确保auto模式能够正确检测玩家的客户端语言设置

3. **添加语言设置持久化**
   - 考虑将玩家的语言设置保存到文件中，以便服务器重启后仍然可用
   - 实现一个配置系统，自动保存和加载玩家的语言偏好

## 技术笔记

在Minecraft 1.21.5中:

1. 获取玩家客户端语言设置的方法:
   - `player.getClientOptions().language()` - 返回类似"en_us"、"zh_cn"的语言代码
   - 注意：这个方法仅在服务端模组中可用

2. 语言文件路径:
   - 默认路径：`config/vlac/lang/`
   - 默认语言文件：`en_US.json` 和 `zh_CN.json`

3. 语言文件刷新:
   - 使用命令 `/vlac reload` 可以重新加载语言文件
   - 删除语言文件再重启服务器也会触发语言文件的重新创建

如果任何开发者找到了更好的解决方案或发现更多问题，请在本文档中更新信息。 